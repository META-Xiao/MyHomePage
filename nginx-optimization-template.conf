# ============================================
# Nginx 性能优化配置模板
# 适用于：宝塔面板 / 自建 Nginx
# ============================================

# 【必须修改】将 YOUR_DOMAIN 替换为你的域名
# 【必须修改】将 YOUR_BACKEND_IP:PORT 替换为你的后端地址（如 172.20.0.60:8081 或 localhost:8081）

# ============================================
# 1. 代理缓存配置（添加到 http 块或 server 块外）
# ============================================
proxy_cache_path /path/to/cache/dir levels=1:2 keys_zone=my_cache:20m inactive=1d max_size=5g;
# 【修改】/path/to/cache/dir 改为实际缓存目录路径


server {
    # ============================================
    # 2. 基础配置（保持宝塔默认，或根据实际情况修改）
    # ============================================
    listen 80;
    listen 443 ssl http2;  # 确保启用 http2
    server_name YOUR_DOMAIN;  # 【修改】替换为你的域名
    
    # SSL 配置（如果有 HTTPS）
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;
    
    # ============================================
    # 3. Gzip 压缩配置 
    # ============================================
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript 
               application/json application/javascript 
               application/xml+rss application/rss+xml 
               font/truetype font/opentype 
               application/vnd.ms-fontobject image/svg+xml;
    gzip_proxied any;
    gzip_disable "msie6";

    # ============================================
    # 4. 静态资源缓存配置 
    # ============================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|mp3|mp4|webp)$ {
        proxy_pass http://YOUR_BACKEND_IP:PORT;  # 【修改】替换为后端地址
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # Nginx 代理缓存
        proxy_cache my_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_key $host$uri$is_args$args;
        add_header X-Cache-Status $upstream_cache_status;
        
        # 浏览器缓存
        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # 连接优化
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_buffering on;
    }

    # ============================================
    # 5. API 请求配置 
    # ============================================
    location /api/ {
        proxy_pass http://YOUR_BACKEND_IP:PORT;  # 【修改】替换为后端地址
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 超时优化
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
        
        # 禁用缓存
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        proxy_http_version 1.1;
    }

    # ============================================
    # 6. Keepalive 优化 
    # ============================================
    keepalive_timeout 65;
    keepalive_requests 100;

    # ============================================
    # 7. 默认代理配置（HTML 等）
    # ============================================
    location / {
        proxy_pass http://YOUR_BACKEND_IP:PORT;  # 【修改】替换为后端地址
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # HTML 短缓存
        expires 5m;
        add_header Cache-Control "public, must-revalidate";
        
        # WebSocket 支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
    }
    
    # ============================================
    # 其他配置（根据需要保留）
    # ============================================
    # - SSL 配置
    # - 日志配置
    # - 安全配置
    # - 错误页面配置
}

# ============================================
# 配置说明
# ============================================
# 1. 将此配置复制到宝塔面板的网站配置文件中
# 2. 替换所有 YOUR_DOMAIN 为你的域名
# 3. 替换所有 YOUR_BACKEND_IP:PORT 为你的后端地址
# 4. 修改缓存目录路径
# 5. 保存并重载 Nginx

# ============================================
# 预期效果
# ============================================
# Performance: 90+
# FCP: < 1.0s
# LCP: < 2.0s
# 首次访问: 3-5s
# 二次访问: < 1s

